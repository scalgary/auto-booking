name: 'Manage Attempt Tags'
description: 'GÃ¨re les tags de tentatives avec prÃ©fixe configurable et calcule l''avance temporelle'

inputs:
  target_date:
    description: 'Date cible (DD-Mth-YY)'
    required: true
  workspace_path:
    description: 'Chemin du workspace Git'
    required: true
  github_token:
    description: 'GitHub token pour push'
    required: true
  github_repository:
    description: 'GitHub repository (owner/repo)'
    required: true
  tag_prefix:
    description: 'PrÃ©fixe pour les tags (ex: "my", "his")'
    required: false
    default: 'bot'

outputs:
  should_continue:
    description: 'true si le workflow doit continuer, false sinon'
    value: ${{ steps.manage.outputs.should_continue }}
  ADVANCE_SEC:
    description: 'Nombre de secondes d''avance/retard (-4, -2, 0, +2, +4...)'
    value: ${{ steps.manage.outputs.ADVANCE_SEC }}
  attempt_number:
    description: 'NumÃ©ro de tentative (0, 1, 2...)'
    value: ${{ steps.manage.outputs.attempt_number }}

runs:
  using: 'composite'
  steps:
    - name: Git setup and manage tags
      id: manage
      shell: bash
      run: |
        echo "======================================"
        echo "ðŸ·ï¸  Managing attempt tags"
        echo "======================================"
        
        WORKSPACE="${{ inputs.workspace_path }}"
        
        # Debug
        echo "ðŸ“‚ Workspace: $WORKSPACE"
        echo "ðŸ“‚ Current dir: $(pwd)"
        
        # Configuration Git - ORDRE IMPORTANT!
        echo "ðŸ”§ Configuring Git..."
        # 1. D'abord ajouter le safe.directory SANS -C
        git config --global --add safe.directory "$WORKSPACE"
        # 2. Ensuite configurer user avec -C
        git -C "$WORKSPACE" config user.name "bot"
        git -C "$WORKSPACE" config user.email "bot@github.com"
        
        # Configurer l'authentification avec le token
        echo "ðŸ” Setting up authentication..."
        git -C "$WORKSPACE" remote set-url origin https://x-access-token:${{ inputs.github_token }}@github.com/${{ inputs.github_repository }}.git
        
        # Fetch tags
        echo "ðŸ·ï¸  Fetching tags from remote..."
        git -C "$WORKSPACE" fetch --tags
        echo "âœ… Tags fetched successfully"
        
        # Variables
        target_date="${{ inputs.target_date }}"
        prefix="${{ inputs.tag_prefix }}"
        success_tag="${prefix}_bot_success_${target_date}"
        
        echo "ðŸ·ï¸  Tag prefix: $prefix"
        echo "ðŸ” Looking for success tag: $success_tag"
        
        # VÃ©rifier si tag de succÃ¨s existe dÃ©jÃ 
        if git -C "$WORKSPACE" tag -l | grep -q "^${success_tag}$"; then
          echo "ðŸ·ï¸  âœ… Success tag already exists: $success_tag"
          echo "ðŸ›‘ Stopping workflow (success already registered)"
          echo "should_continue=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ðŸ“ Success tag not found, continuing..."
        echo "should_continue=true" >> $GITHUB_OUTPUT
        
        # Compter les tentatives existantes pour cette date avec ce prÃ©fixe
        attempt_count=$(git -C "$WORKSPACE" tag -l "${prefix}_bot_run_${target_date}_*" | wc -l)
        echo "ðŸ“Š Existing attempts: $attempt_count"
        echo "ðŸŽ¯ This will be attempt #$attempt_count"
        
        # Calculer l'avance : attempt 0 = -4, puis -2, 0, +2, +4...
        if [ $attempt_count -eq 0 ]; then
          ADVANCE_SEC=-4
          echo "â° First attempt: ${ADVANCE_SEC} seconds (BEFORE target)"
        else
          ADVANCE_SEC=$(( -4 + attempt_count * 2 ))
          if [ $ADVANCE_SEC -lt 0 ]; then
            echo "â° Attempt #${attempt_count}: ${ADVANCE_SEC} seconds (BEFORE target)"
          else
            echo "â° Attempt #${attempt_count}: +${ADVANCE_SEC} seconds (AFTER target)"
          fi
        fi
        
        # CrÃ©er le tag de tentative
        run_tag="${prefix}_bot_run_${target_date}_${attempt_count}"
        echo "ðŸ·ï¸  Creating tag: $run_tag"
        git -C "$WORKSPACE" commit --allow-empty -m "âœ… $run_tag"
        git -C "$WORKSPACE" tag "$run_tag"
        
        echo "ðŸ“¤ Pushing tag to remote..."
        git -C "$WORKSPACE" push origin HEAD "$run_tag"
        echo "âœ… Tag pushed successfully!"
        
        # Exporter les outputs
        echo "ADVANCE_SEC=$ADVANCE_SEC" >> $GITHUB_OUTPUT
        echo "attempt_number=$attempt_count" >> $GITHUB_OUTPUT
        
        echo "======================================"