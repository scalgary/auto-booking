name: Simple Registration

on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (format: DD-MMM-YY, e.g., 15-Sep-25)'
        required: true
        default: '15-Sep-25'
        type: string
      target_time:
        description: 'Target time Calgary (format: H:MM or HH:MM, e.g., 8:00)'
        required: true
        default: '8:00'
        type: string

jobs:
  registration:
    runs-on: ubuntu-latest
    name: Registration
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set parameters
        id: params
        run: |
          echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          echo "time=${{ github.event.inputs.target_time }}" >> $GITHUB_OUTPUT

      - name: Display execution info
        run: |
          echo "üéæ Registration for ${{ steps.params.outputs.date }} at ${{ steps.params.outputs.time }}"

      - name: Run registration
        uses: devcontainers/ci@v0.3
        env:
          YOUR_SECRET_EMAIL: ${{ secrets.YOUR_SECRET_EMAIL }}
          YOUR_SECRET_PASSWORD: ${{ secrets.YOUR_SECRET_PASSWORD }}
          YOUR_SECRET_LOGON_URL: ${{ secrets.YOUR_SECRET_LOGON_URL }}
          YOUR_SECRET_PLANNING_URL: ${{ secrets.YOUR_SECRET_PLANNING_URL }}
          YOUR_SECRET_LOGIN_URL: ${{ secrets.YOUR_SECRET_LOGIN_URL }}
          YOUR_SECRET_MY_NAME: ${{ secrets.YOUR_SECRET_MY_NAME }}
        with:
          runCmd: |
            python3 execution.py "${{ steps.params.outputs.date }}" "${{ steps.params.outputs.time }}"
            echo "PYTHON_EXIT_CODE=$?" >> $GITHUB_ENV
          push: never

      - name: Create success tag if registration succeeded
        run: |
          target_date="${{ steps.params.outputs.date }}"
          
          if [ "${PYTHON_EXIT_CODE:-1}" = "0" ]; then
            echo "‚úÖ Registration succeeded"
            
            tag_name="success_${target_date}"
            
            git commit --allow-empty -m "‚úÖ Registration succeeded for ${target_date}"
            git tag -a "$tag_name" -m "Registration success for ${target_date} - $(date -u)"
            git push origin ${{ github.ref_name }}
            git push origin "$tag_name"
            
            echo "üè∑Ô∏è Success tag created: $tag_name"
          else
            echo "‚ùå Registration failed (exit code: ${PYTHON_EXIT_CODE:-unknown})"
          fi